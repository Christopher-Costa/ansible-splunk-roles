- name: Create {{ cs_app_name }} app directories
  become: yes
  become_user: "{{ splunk_user }}"
  file:
    state: directory
    path: /opt/splunk/etc/apps/{{ cs_app_name }}/local/

- name: Create {{ cs_app_name }} app files
  become: yes
  become_user: "{{ splunk_user }}"
  copy:
    dest: /opt/splunk/etc/apps/{{ cs_app_name }}/local/server.conf
    content: ""
    force: no
    group: "{{ splunk_group }}"
    owner: "{{ splunk_user }}"

- name: Configure server.conf
  become: true
  become_user: "{{ splunk_user }}"
  blockinfile:
    path: /opt/splunk/etc/apps/{{ cs_app_name }}/local/server.conf
    marker: "## {mark} ANSIBLE MANAGED BLOCK ##" 
    backup: yes
    block: |
      [general]
      site = {{ splunk_site }}

      [replication_port://{{ splunk_replication_port }}]

      [clustering]
      master_uri = https://{{ hostvars[cluster_master]['sys_ip'] }}:{{ hostvars[cluster_master]['splunk_mgmt_port'] | default(8089) }}
      pass4SymmKey = {{ splunk_cluster_password }}
      mode = slave
  notify: 
    - restart Splunk
